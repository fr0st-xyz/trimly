/**
 * LightSession - Early Hide CSS
 *
 * Phase 1: CSS containment for render optimization
 * Phase 2: content-visibility for browsers that support it
 *
 * Strategy:
 * - contain: layout paint style - works everywhere, tells browser elements are isolated
 * - content-visibility: auto - more aggressive optimization, wrapped in @supports for Firefox 125+
 */

/* ============================================================================
 * PHASE 1: CSS Containment (baseline - works in all browsers)
 *
 * `contain: layout paint style` tells the browser:
 * - layout: element's internal layout doesn't affect external elements
 * - paint: element's content won't paint outside its bounds
 * - style: properties that can affect descendants are scoped
 *
 * This enables browser optimizations even without content-visibility.
 * ============================================================================ */

[data-message-id],
[data-turn],
[data-testid="conversation-turn"],
[data-testid^="conversation-turn-"] {
  contain: layout paint style;
}

/* ============================================================================
 * PHASE 2: content-visibility: auto (where supported)
 *
 * Browser skips layout+paint for off-screen content entirely.
 * More aggressive than contain alone.
 *
 * Support: Chrome 85+, Edge 85+, Firefox 125+
 * Wrapped in @supports for graceful degradation in older Firefox.
 *
 * IMPORTANT: content-visibility: auto breaks getBoundingClientRect() for
 * off-screen elements. Code must NOT rely on Y-coordinate reads.
 * ============================================================================ */

@supports (content-visibility: auto) {
  [data-message-id],
  [data-turn],
  [data-testid="conversation-turn"],
  [data-testid^="conversation-turn-"] {
    content-visibility: auto;
    /* Approximate message height to prevent layout shifts during scroll */
    contain-intrinsic-size: auto 200px;
  }
}

/* ============================================================================
 * PHASE 3: Pre-trim hide - DISABLED
 *
 * NOTE: display:none blocks LCP and causes regression (+455ms).
 * content-visibility: auto above provides the optimization without blocking LCP.
 *
 * Keeping the attribute mechanism for potential future use with a different
 * approach (e.g., opacity: 0 with immediate reveal, or only hiding overflow).
 * ============================================================================ */

/* DISABLED - causes LCP regression
html[data-ls-pretrim="1"] [data-message-id],
html[data-ls-pretrim="1"] [data-turn],
html[data-ls-pretrim="1"] [data-testid="conversation-turn"],
html[data-ls-pretrim="1"] [data-testid^="conversation-turn-"] {
  display: none !important;
}
*/

/* ============================================================================
 * ULTRA LEAN MODE - Aggressive performance optimizations
 *
 * Activated via: document.documentElement.classList.add('ls-ultra-lean')
 *
 * Optimizations:
 * 1. Kill all animations and transitions
 * 2. Remove shadows, blurs, and filters
 * 3. Force instant scroll behavior
 * 4. Enhanced CSS containment
 * 5. Isolate composer from messages area
 * ============================================================================ */

/* Kill animations and transitions - FALLBACK (container only, no descendants)
   Works even when trimmer is disabled - [data-ls-messages-root] may not exist */
html.ls-ultra-lean main,
html.ls-ultra-lean [role="main"] {
  animation: none !important;
  transition: none !important;
}

/* Kill animations and transitions - FULL (when messages-root is set by trimmer)
   Scoped to messages-root to reduce style recalc cost on dynamic UI changes. */
html.ls-ultra-lean [data-ls-messages-root] *,
html.ls-ultra-lean [data-ls-messages-root] *::before,
html.ls-ultra-lean [data-ls-messages-root] *::after {
  animation: none !important;
  animation-duration: 0s !important;
  transition: none !important;
  transition-duration: 0s !important;
}

/* Kill shadows, blurs, and filters on message elements */
html.ls-ultra-lean [data-message-id],
html.ls-ultra-lean [data-turn],
html.ls-ultra-lean [data-testid*="turn"],
html.ls-ultra-lean main,
html.ls-ultra-lean [role="main"] {
  box-shadow: none !important;
  text-shadow: none !important;
  backdrop-filter: none !important;
  filter: none !important;
}

/* Force instant scroll - FALLBACK (container only) */
html.ls-ultra-lean main,
html.ls-ultra-lean [role="main"] {
  scroll-behavior: auto !important;
}

/* Force instant scroll - FULL (when messages-root is set by trimmer) */
html.ls-ultra-lean [data-ls-messages-root],
html.ls-ultra-lean [data-ls-messages-root] * {
  scroll-behavior: auto !important;
}

/* Enhanced containment for messages */
html.ls-ultra-lean [data-message-id],
html.ls-ultra-lean [data-turn],
html.ls-ultra-lean [data-testid="conversation-turn"],
html.ls-ultra-lean [data-testid^="conversation-turn-"] {
  /* Note: using layout paint style instead of strict - strict includes 'size'
     which clips content that exceeds contain-intrinsic-size */
  contain: layout paint style;
  content-visibility: auto;
  contain-intrinsic-size: auto 200px;
}

/* Isolate composer to prevent observer noise */
html.ls-ultra-lean form[class*="composer" i],
html.ls-ultra-lean [data-testid*="composer" i],
html.ls-ultra-lean textarea,
html.ls-ultra-lean [contenteditable="true"],
html.ls-ultra-lean [role="textbox"] {
  contain: layout paint style;
  transform: translateZ(0); /* Force GPU layer for smoother typing */
}

/* Disable overflow anchor to prevent scroll jumps */
html.ls-ultra-lean main,
html.ls-ultra-lean [role="main"],
html.ls-ultra-lean [data-ls-messages-root] {
  overflow-anchor: none;
}
